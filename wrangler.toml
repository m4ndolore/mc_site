# =============================================================================
# Cloudflare Worker Configuration for mc-router
# =============================================================================
#
# CONFIGURATION PATTERN:
#   - Non-secrets: Values here MUST align with config/*.yaml (source of truth)
#   - Secrets: Stored in .env.local, symlinked to .dev.vars for wrangler
#
# LOCAL DEVELOPMENT:
#   1. Ensure .dev.vars symlink exists: ln -s .env.local .dev.vars
#   2. Run: wrangler dev --env dev
#
# PRODUCTION DEPLOYMENT:
#   1. Set secrets: wrangler secret put MC_OAUTH_CLIENT_ID
#                   wrangler secret put MC_OAUTH_CLIENT_SECRET
#                   wrangler secret put SESSION_SECRET
#   2. Deploy: wrangler deploy
#
# See docs/ai/RULES.md "Static Sites & Cloudflare Workers" for full details.
# =============================================================================

name = "mc-router"
main = "cloudflare/merge-router.js"
compatibility_date = "2024-01-01"

# -----------------------------------------------------------------------------
# Production non-secrets (source of truth: config/base.yaml)
# -----------------------------------------------------------------------------
[vars]
OIDC_ISSUER_URL = "https://via.mergecombinator.com"
OAUTH_LOGOUT_URL = "https://via.mergecombinator.com/application/o/defense-builders/end-session/"
COOKIE_DOMAIN = ".mergecombinator.com"  # Enables cross-subdomain sessions (www, docs)
# CONTROL_ADMIN_GROUPS = "via-admins,sigmablox-admins"  # Optional override for /control access

# Proxy origins (only routes still proxied through merge-router)
MC_PAGES_ORIGIN = "https://mc-site-dr4.pages.dev"
SIGMABLOX_ORIGIN = "https://www.sigmablox.com"
CONTROL_ORIGIN = "https://control.mergecombinator.com"
OPPORTUNITIES_PAGES_URL = "https://mc-opportunities.pages.dev"

# Cloudflare Turnstile (public site key - NOT a secret)
TURNSTILE_SITE_KEY = "0x4AAAAAACLB7AvgydG3i6FP"

# Removed in Phase 0 (phase0-routing-complete):
# APP_ORIGIN, WINGMAN_ORIGIN → 301 redirects to guild.*/wingman.* (not proxied)
# SIGMABLOX_API_ORIGIN, API_CORS_ORIGINS → 301 redirect to api.* (not proxied)
# SBIR_ORIGIN, WINGMAN_CONSOLE_ENABLED → no longer referenced

# -----------------------------------------------------------------------------
# Staging environment - for testing changes before production
# Deploy with: wrangler deploy --env staging
# Test at: https://mc-router-staging.<account>.workers.dev
# Secrets: wrangler secret put MC_OAUTH_CLIENT_ID --env staging (copy from prod)
# -----------------------------------------------------------------------------
[env.staging]
name = "mc-router-staging"

[env.staging.vars]
# Same as prod - we're testing the router logic, not the backends
OIDC_ISSUER_URL = "https://via.mergecombinator.com"
OAUTH_LOGOUT_URL = "https://via.mergecombinator.com/application/o/defense-builders/end-session/"
COOKIE_DOMAIN = ".mergecombinator.com"
MC_PAGES_ORIGIN = "https://mc-site-dr4.pages.dev"
SIGMABLOX_ORIGIN = "https://www.sigmablox.com"
CONTROL_ORIGIN = "https://control.mergecombinator.com"
OPPORTUNITIES_PAGES_URL = "https://mc-opportunities.pages.dev"
TURNSTILE_SITE_KEY = "0x4AAAAAACLB7AvgydG3i6FP"

# -----------------------------------------------------------------------------
# Local development overrides (source of truth: config/dev.local.yaml)
# Run with: wrangler dev --env dev
# -----------------------------------------------------------------------------
[env.dev]
name = "mc-router-dev"

[env.dev.vars]
OIDC_ISSUER_URL = "http://localhost:9000"  # Must match config/dev.local.yaml line 16
OAUTH_LOGOUT_URL = "http://localhost:9000/application/o/defense-builders/end-session/"
MC_PAGES_ORIGIN = "http://localhost:3000"
SIGMABLOX_ORIGIN = "http://localhost:2368"
CONTROL_ORIGIN = "http://localhost:3300"
# Use Turnstile test key for local dev (always passes)
TURNSTILE_SITE_KEY = "1x00000000000000000000AA"
