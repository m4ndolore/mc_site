# =============================================================================
# Cloudflare Worker Configuration for mc-router
# =============================================================================
#
# CONFIGURATION PATTERN:
#   - Non-secrets: Values here MUST align with config/*.yaml (source of truth)
#   - Secrets: Stored in .env.local, symlinked to .dev.vars for wrangler
#
# LOCAL DEVELOPMENT:
#   1. Ensure .dev.vars symlink exists: ln -s .env.local .dev.vars
#   2. Run: wrangler dev --env dev
#
# PRODUCTION DEPLOYMENT:
#   1. Set secrets: wrangler secret put MC_OAUTH_CLIENT_ID
#                   wrangler secret put MC_OAUTH_CLIENT_SECRET
#                   wrangler secret put SESSION_SECRET
#   2. Deploy: wrangler deploy
#
# See docs/ai/RULES.md "Static Sites & Cloudflare Workers" for full details.
# =============================================================================

name = "mc-router"
main = "cloudflare/merge-router.js"
compatibility_date = "2024-01-01"

# -----------------------------------------------------------------------------
# Production non-secrets (source of truth: config/base.yaml)
# -----------------------------------------------------------------------------
[vars]
OIDC_ISSUER_URL = "https://via.mergecombinator.com"
OAUTH_LOGOUT_URL = "https://via.mergecombinator.com/application/o/mergecombinator/end-session/"
COOKIE_DOMAIN = ".mergecombinator.com"  # Enables cross-subdomain sessions (www, docs)
# CONTROL_ADMIN_GROUPS = "via-admins,sigmablox-admins"  # Optional override for /control access
MC_PAGES_ORIGIN = "https://mc-site-dr4.pages.dev"
SIGMABLOX_ORIGIN = "https://www.sigmablox.com"
SIGMABLOX_API_ORIGIN = "https://api.sigmablox.com"
# Console origins - DNS configured 2026-02-13, placeholder pages deployed
# See REQ-INFRA-003 for subdomain readiness tracking
APP_ORIGIN = "https://app.mergecombinator.com"         # CNAME → mc-app-placeholder.pages.dev
WINGMAN_ORIGIN = "https://wingman.mergecombinator.com" # CNAME → mc-wingman-placeholder.pages.dev
CONTROL_ORIGIN = "https://control.mergecombinator.com" # CNAME → mc-control-placeholder.pages.dev
SBIR_ORIGIN = "https://sbir.mergecombinator.com"       # Railway deployment
OPPORTUNITIES_PAGES_URL = "https://mc-opportunities.pages.dev"
WINGMAN_CONSOLE_ENABLED = "false"

# Cloudflare Turnstile (public site key - NOT a secret)
TURNSTILE_SITE_KEY = "0x4AAAAAACLB7AvgydG3i6FP"

# CORS allowed origins (comma-separated)
API_CORS_ORIGINS = "https://mergecombinator.com,https://www.mergecombinator.com,https://console.mergecombinator.com"

# -----------------------------------------------------------------------------
# Staging environment - for testing changes before production
# Deploy with: wrangler deploy --env staging
# Test at: https://mc-router-staging.<account>.workers.dev
# Secrets: wrangler secret put MC_OAUTH_CLIENT_ID --env staging (copy from prod)
# -----------------------------------------------------------------------------
[env.staging]
name = "mc-router-staging"

[env.staging.vars]
# Same as prod - we're testing the router logic, not the backends
OIDC_ISSUER_URL = "https://via.mergecombinator.com"
OAUTH_LOGOUT_URL = "https://via.mergecombinator.com/application/o/mergecombinator/end-session/"
COOKIE_DOMAIN = ".mergecombinator.com"
MC_PAGES_ORIGIN = "https://mc-site-dr4.pages.dev"
SIGMABLOX_ORIGIN = "https://www.sigmablox.com"
SIGMABLOX_API_ORIGIN = "https://api.sigmablox.com"
APP_ORIGIN = "https://app.mergecombinator.com"
WINGMAN_ORIGIN = "https://wingman.mergecombinator.com"
CONTROL_ORIGIN = "https://control.mergecombinator.com"
SBIR_ORIGIN = "https://sbir.mergecombinator.com"       # Railway deployment
OPPORTUNITIES_PAGES_URL = "https://mc-opportunities.pages.dev"
WINGMAN_CONSOLE_ENABLED = "false"
TURNSTILE_SITE_KEY = "0x4AAAAAACLB7AvgydG3i6FP"
API_CORS_ORIGINS = "https://mergecombinator.com,https://www.mergecombinator.com,https://console.mergecombinator.com"

# -----------------------------------------------------------------------------
# Local development overrides (source of truth: config/dev.local.yaml)
# Run with: wrangler dev --env dev
# -----------------------------------------------------------------------------
[env.dev]
name = "mc-router-dev"

[env.dev.vars]
OIDC_ISSUER_URL = "http://localhost:9000"  # Must match config/dev.local.yaml line 16
OAUTH_LOGOUT_URL = "http://localhost:9000/application/o/mergecombinator/end-session/"
MC_PAGES_ORIGIN = "http://localhost:3000"
SIGMABLOX_ORIGIN = "http://localhost:2368"
SIGMABLOX_API_ORIGIN = "http://localhost:2368"
APP_ORIGIN = "http://localhost:3003"
WINGMAN_ORIGIN = "http://localhost:5173"
CONTROL_ORIGIN = "http://localhost:3300"
WINGMAN_CONSOLE_ENABLED = "false"
# Use Turnstile test key for local dev (always passes)
TURNSTILE_SITE_KEY = "1x00000000000000000000AA"
API_CORS_ORIGINS = "http://localhost:3000,http://localhost:3002,http://localhost:5173"
